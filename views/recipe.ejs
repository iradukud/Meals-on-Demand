<%- include('partials/header') -%>
<%- include('partials/nav') -%>

<main class="w-100 m-auto text-center ">

  <%
    //error alerts 
    if (locals.messages.errors) { 
      messages.errors.forEach( el=> { 
  %>
  <div class="alert alert-danger"><%= el.msg %></div>
  <%
      });
    };
  
    //information alerts 
    if (locals.messages.info) { 
      messages.info.forEach( el=> { 
  %>
  <div class="alert alert-info"><%= el.msg %></div>
  <%
      });
    };
  %>

  <%# page image %>
  <img class="mb-2 mt-2" src="/imgs/pageImage.png" alt="bookImage" width="100">

  <%  
    //variables plugged into recipe display
    let name = '';
    let image = '';
    let type = [];
    let ingredients = [];
    let instructions = []; 
    let reference = '';
   

    //recipe from API
    if (typeof apiRecipe!='undefined') {
      name = apiRecipe['recipe']['label'];
      image = apiRecipe['recipe']['image'];
      type = apiRecipe['recipe']['mealType'];
      ingredients = apiRecipe['recipe']['ingredientLines'];
      reference = apiRecipe['recipe']['url'];
    };
  
    //recipe from DB
    if (typeof dbRecipe!='undefined') { 
      name = dbRecipe['name'];
      image = dbRecipe['image'];
      type = dbRecipe['type'];
      ingredients = dbRecipe['ingredients'];
      instructions = dbRecipe['instructions'];
      reference = dbRecipe['reference'];
    };
  %>

  <%# recipe name %>
  <h1 class="display-5 fw-bold lh-1 mb-3 text-center" id="editName"><%= name %></h1>

  <section class="row justify-content-center mt-3 px-5">
    <%# container recipe %>
    <div class="card shadow-sm col-6 ">

      <%# recipe image %>
      <div>
        <img src="<%= image %>" class="mt-3" width="50%" height="300"></img>
      </div>

      <%# recipe category %>
      <div class="d-flex justify-content-center mt-3">
        <% 
          if (typeof dbRecipe!='undefined') {
            type.forEach(mtype => {
        %>
        <h6 class="btn-primary btn-lg px-4 me-md-2 types"><%= mtype %></h6>
        <%
            });
          };

          if (typeof apiRecipe!='undefined') {
        %>
        <h6 class="btn-primary btn-lg px-4 me-md-2"><%= type %></h6>
        <%
          };
        %>
      </div>

      <%# recipe ingredients %>
      <div class="card-body">
        <h4>Ingredients</h4>
        <ul class="px-0">

          <%# each ingredient %>
          <% 
            ingredients.forEach(ingredient => {
          %>
          <li class="border-bottom editIngredient">
            <%= ingredient %>
          </li>
          <%
            });
            
            //add ingredients if recipe is from DB
            if (typeof dbRecipe!='undefined') { 
          %>
          <div>
            <%# button trigger add modal %>
            <button type="button" class="btn btn-primary mt-2 addIngrInst" data-toggle="modal" data-target="#addModalCenter">
              +Add ingredient
            </button>
          </div>
          <%
            };
          %>
        </ul>
      </div>

      <%# recipe instructions %>
      <div class="card-body">
        <h4>Instructions</h4>
        <ul class="px-0">

          <%# each instruction %>
          <% 
            instructions.forEach(instruction => {
          %>
          <li class="border-bottom editInstruction">
            <%= instruction %>
          </li>
          <%
            })

            //add ingredients if recipe is from DB
            if (typeof dbRecipe!='undefined') { 
          %>
          <div>
            <%# button trigger add modal %>
            <button type="button" class="btn btn-primary mt-2 addIngrInst" data-toggle="modal" data-target="#addModalCenter">
              +Add instruction
            </button>
          </div>
          <%
            }
          %>
        </ul>
      </div>

      <%# recipe reference %>
      <div class="card-body">
        <h4>Recipe Reference</h4>
        <%# link to original recipe %>
        <a href="<%= reference %>" target="_blank" id="editreference">
          <h6>Reference Site/Video</h6>
        </a>
      </div>

      <%# features related to DB API results %>
      <% 
        if (typeof apiRecipe!='undefined') { 
      %>
      <div class="d-flex justify-content-around align-items-center px-4 mb-3 mt-5">

        <%# back button %>
        <button onclick="history.back()" class="btn btn-outline-secondary btn-lg">Back</button>

        <%# save button %>
        <form action="/apiRecipes/save" method="POST">
          <input type="hidden" name="recipeName" value="<%=name%>">
          <input type="hidden" name="recipeImage" value="<%=image%>">
          <input type="hidden" name="recipeMealtype" value="<%=type%>">
          <input type="hidden" name="recipeIngredients" value="<%=ingredients%>">
          <input type="hidden" name="recipeReference" value="<%=reference%>">
          <button class="btn btn-primary btn-lg" type="submit">Save</button>
        </form>
      </div>
      <%
        }
      %>

      <%# features related to DB results %>
      <% 
        if (typeof dbRecipe!='undefined') { 
      %>
      <div class="d-flex justify-content-around align-items-center px-4 mb-3 mt-5">
        <%# back button %>
        <button onclick="history.back()" class="btn btn-outline-secondary btn-lg">Back</button>

        <%# edit button %>
        <button class="btn btn-primary btn-lg fas fa-edit" id="editRecipe"></button>
        <span hidden id="recipeId"><%=dbRecipe['_id']%></span>

        <%# delete button %>
        <form action="/dbRecipes/delete/<%= dbRecipe.id %>?_method=DELETE" method="POST">
          <button class="btn btn-primary btn-lg fa fa-trash"></button>
        </form>
      </div>
      <%
        }
      %>

    </div>
  </section>

  <%# add ingredient/instruction modal %>
  <div class="modal fade" id="addModalCenter" tabindex="-1" role="dialog" aria-labelledby="addModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalTitle">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <%# form collecting user inputs %>
        <form action="/dbRecipes/addIngrInst" id="recipeForm" method='POST'>
          <div class="modal-body">

            <%# recipe id %>
            <input type="hidden" class="form-control" aria-describedby="recipeDBId" name="recipeDBId" value="<%=dbRecipe['_id'] %>">

            <%# recipe reference %>
            <div class="mb-3 form-floating">
              <input type="text" class="form-control" id="addTo" aria-describedby="addToHelp">
              <label for="recipeReference" id="addToLabel"></label>
            </div>

          </div>

          <%# submit recipe %>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary close fa fa-window-close" data-dismiss="modal"></button>
            <button type="submit" class="btn btn-primary fas fa-chevron-circle-right"></button>
          </div>
      </div>
      </form>
    </div>
  </div>



</main>

<%- include('partials/footer') -%>